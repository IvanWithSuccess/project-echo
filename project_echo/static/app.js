let scrapedAudience = [];\n\ndocument.addEventListener(\'DOMContentLoaded\', () => {\n    switchSection(\'dashboard\');\n});\n\nfunction switchSection(sectionId) {\n    document.querySelectorAll(\'.content-section\').forEach(s => s.classList.remove(\'active\'));\n    document.querySelectorAll(\'.sidebar nav li\').forEach(i => i.classList.remove(\'active\'));\n\n    document.getElementById(sectionId)?.classList.add(\'active\');\n    document.getElementById(`nav-${sectionId}`)?.classList.add(\'active\');\n\n    if (sectionId === \'accounts\') loadAccounts();\n    if (sectionId === \'audiences\') { loadAccounts(); loadAndDisplayAudiences(); }\n    if (sectionId === \'campaigns\') { loadCampaigns(); loadAccountsForCampaign(); loadAndDisplayAudiences(); }\n}\n\n// --- Accounts Management ---\nfunction loadAccounts() {\n    fetch(\'/api/accounts\').then(r => r.json()).then(data => {\n        const tableBody = document.getElementById(\'accounts-table-body\');\n        const scraperSelect = document.getElementById(\'scraper-account\');\n        tableBody.innerHTML = \'\';\n        scraperSelect.innerHTML = \'<option disabled selected>Select an account</option>\';\n        data.forEach(acc => {\n            tableBody.innerHTML += `<tr><td>${acc.phone}</td><td>${acc.username || \'N/A\'}</td><td><button class=\"delete-btn\" onclick=\"deleteAccount(\'${acc.phone}\')\">Delete</button></td></tr>`;\n            scraperSelect.innerHTML += `<option value=\"${acc.phone}\">${acc.phone} (${acc.username || \'N/A\'})</option>`;\n        });\n    }).catch(e => console.error(\'Error loading accounts:\', e));\n}\n\nfunction addAccount() {\n    const phone = prompt(\'Enter phone number (e.g., +1234567890):\');\n    if (!phone) return;\n\n    fetch(\'/api/accounts/add\', { method: \'POST\', headers: { \'Content-Type\': \'application/json\' }, body: JSON.stringify({ phone }) })\n    .then(r => r.json()).then(data => {\n        if (data.status === \'ok\') {\n            if (data.message.includes(\'Verification code\')) {\n                const code = prompt(\'Enter verification code:\');\n                if (code) finalizeLogin(phone, code);\n            } else if (data.message.includes(\'authorized\')) {\n                alert(\'Account added successfully!\');\n                loadAccounts();\n            } else {\n                 alert(data.message);\n            }\n        } else {\n            alert(\`Error: ${data.message}\`);\n        }\n    });\n}\n\nfunction finalizeLogin(phone, code, password = null) {\n    const payload = { phone, code, password };\n    fetch(\'/api/accounts/finalize\', { method: \'POST\', headers: { \'Content-Type\': \'application/json\' }, body: JSON.stringify(payload) })\n    .then(r => r.json()).then(data => {\n        if (data.status === \'ok\') {\n            if (data.message.includes(\'2FA\')) {\n                const pass = prompt(\'Enter 2FA password:\');\n                if (pass) finalizeLogin(phone, null, pass);\n            } else {\n                alert(data.message);\n                loadAccounts();\n            }\n        } else {\n            alert(\`Error: ${data.message}\`);\n        }\n    });\n}\n\nfunction deleteAccount(phone) {\n    if (!confirm(`Are you sure you want to delete account ${phone}? This will also delete the session file.`)) return;\n\n    fetch(\'/api/accounts/delete\', { method: \'POST\', headers:{\'Content-Type\':\'application/json\'}, body:JSON.stringify({phone}) })\n    .then(r => r.json()).then(data => {\n        alert(data.message);\n        if (data.status === \'ok\') loadAccounts();\n    });\n}\n\n// --- Audience Management ---\nfunction loadAndDisplayAudiences() {\n    fetch(\'/api/audiences\').then(r => r.json()).then(data => {\n        if (data.status !== \'ok\') return;\n        const list = document.getElementById(\'saved-audiences-list\');\n        const select = document.getElementById(\'campaign-audience-select\');\n        list.innerHTML = data.audiences.length ? \'\' : \'<li>No saved audiences.</li>\';\n        select.innerHTML = \'<option disabled selected value=\"\">Select an audience</option>\';\n        data.audiences.forEach(name => {\n            list.innerHTML += `<li>${name}</li>`;\n            select.innerHTML += `<option value=\"${name}\">${name}</option>`;\n        });\n    }).catch(e => console.error(\'Error loading audiences:\', e));\n}\n\nfunction scrapeAudience() {\n    const phone = document.getElementById(\'scraper-account\').value;\n    const chat_link = document.getElementById(\'chat-link\').value;\n    const statusEl = document.getElementById(\'scraper-status\');\n\n    if (!phone || !chat_link) { return alert(\'Please select an account and provide a chat link.\'); }\n\n    statusEl.innerText = \'Scraping in progress...\';\n    document.getElementById(\'save-audience-btn\').style.display = \'none\';\n\n    fetch(\'/api/audience/scrape\', { method: \'POST\', headers:{\'Content-Type\':\'application/json\'}, body:JSON.stringify({phone, chat_link}) })\n    .then(r => r.json()).then(data => {\n        if (data.status === \'ok\') {\n            statusEl.innerText = `Scraping complete! Found ${data.users.length} users.`;\n            scrapedAudience = data.users;\n            populateAudienceTable(scrapedAudience);\n            document.getElementById(\'save-audience-btn\').style.display = \'inline-block\';\n        } else {\n            statusEl.innerText = `Error: ${data.message}`;\n        }\n    }).catch(e => statusEl.innerText = `Fetch Error: ${e}`);\n}\n\nfunction saveAudience() {\n    const filename = prompt(\"Enter a name for this audience (e.g., \'crypto_investors\'):\");\n    if (!filename || !scrapedAudience.length) return;\n\n    fetch(\'/api/audiences/save\', { method: \'POST\', headers:{\'Content-Type\':\'application/json\'}, body: JSON.stringify({filename, users: scrapedAudience}) })\n    .then(r => r.json()).then(data => {\n        alert(data.message);\n        if (data.status === \'ok\') {\n            loadAndDisplayAudiences(); \n            scrapedAudience = [];\n            document.getElementById(\'audience-table-body\').innerHTML = \'\';\n            document.getElementById(\'save-audience-btn\').style.display = \'none\';\n            document.getElementById(\'scraper-status\').innerText = \'\';\n        }\n    });\n}\n\nfunction populateAudienceTable(users) {\n    const tableBody = document.getElementById(\'audience-table-body\');\n    tableBody.innerHTML = \'\';\n    users.forEach(user => {\n        tableBody.innerHTML += `<tr><td>${user.id}</td><td>${user.username || \'N/A\'}</td><td>${user.first_name || \'\'} ${user.last_name || \'\'}</td></tr>`;\n    });\n}\n\n\n// --- Campaign Management ---\nfunction loadCampaigns() {\n    fetch(\'/api/campaigns\').then(r => r.json()).then(campaigns => {\n        const tableBody = document.getElementById(\'campaigns-table-body\');\n        tableBody.innerHTML = \'\';\n        campaigns.forEach(c => {\n            const actions = c.status === \'Draft\' \n                ? `<button onclick=\"startCampaign(\'${c.id}\')\">Start</button><button onclick=\"editCampaign(\'${c.id}\')\">Edit</button>`\n                : (c.status === \'In Progress\' ? \'<i>Running...</i>\' : \'<i>Finished</i>\');\n            \n            tableBody.innerHTML += `<tr>\n                <td>${c.name}</td>\n                <td>${c.audience}</td>\n                <td>${c.status}</td>\n                <td>${actions} <button class=\"delete-btn\">Delete</button></td>\n            </tr>`;\n        });\n    });\n}\n\nfunction startCampaign(campaignId) {\n    if (!confirm(\"Are you sure you want to start this campaign? It will begin sending messages.\")) return;\n\n    fetch(\'/api/campaigns/start\', { method: \'POST\', headers:{\'Content-Type\':\'application/json\'}, body: JSON.stringify({id: campaignId}) })\n    .then(r => r.json())\n    .then(data => {\n        alert(data.message);\n        if(data.status === \'ok\') loadCampaigns(); // Refresh to show \'In Progress\' status\n    });\n}\n\nfunction editCampaign(campaignId) {\n    alert(\"Editing functionality to be fully implemented. For now, create a new campaign.\");\n}\n\nfunction toggleCampaignForm(show) {\n    document.getElementById(\'campaign-form-container\').style.display = show ? \'block\' : \'none\';\n    document.getElementById(\'campaign-list-view\').style.display = show ? \'none\' : \'block\';\n    if (!show) { \n        document.getElementById(\'campaign-id\').value = \'\';\n        document.getElementById(\'campaign-name\').value = \'\';\n        document.getElementById(\'campaign-message\').value = \'\';\n        document.getElementById(\'campaign-audience-select\').value = \'\';\n        document.querySelectorAll(\'#campaign-accounts-select input:checked\').forEach(i => i.checked = false);\n    }\n}\n\nfunction loadAccountsForCampaign(){\n     fetch(\'/api/accounts\').then(r => r.json()).then(data => {\n        const container = document.getElementById(\'campaign-accounts-select\');\n        container.innerHTML = \'\';\n        data.forEach(acc => {\n            container.innerHTML += `<label><input type=\"checkbox\" name=\"campaign-account\" value=\"${acc.phone}\"> ${acc.phone} (${acc.username || \'N/A\'})</label>`;\n        });\n    });\n}\n\nfunction saveCampaign() {\n    const campaign = {\n        id: document.getElementById(\'campaign-id\').value,\n        name: document.getElementById(\'campaign-name\').value,\n        message: document.getElementById(\'campaign-message\').value,\n        audience: document.getElementById(\'campaign-audience-select\').value,\n        accounts: Array.from(document.querySelectorAll(\'#campaign-accounts-select input:checked\')).map(i => i.value)\n    };\n\n    if (!campaign.name || !campaign.message || !campaign.audience || campaign.accounts.length === 0) {\n        return alert(\'Please fill all fields: Name, Message, Audience, and select at least one account.\');\n    }\n\n    fetch(\'/api/campaigns/save\', { method: \'POST\', headers:{\'Content-Type\':\'application/json\'}, body: JSON.stringify(campaign) })\n    .then(r => r.json()).then(data => {\n        if (data.status === \'ok\') {\n            alert(data.message);\n            toggleCampaignForm(false);\n            loadCampaigns();\n        } else {\n            alert(`Error: ${data.message}`);\n        }\n    });\n}\n